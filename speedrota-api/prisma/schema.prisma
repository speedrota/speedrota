generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  passwordHash        String               @map("password_hash")
  nome                String
  telefone            String?
  plano               Plano                @default(FREE)
  tipoUsuario         TipoUsuario          @default(ENTREGADOR) @map("tipo_usuario")
  mpCustomerId        String?              @map("mp_customer_id")
  planoExpiraEm       DateTime?            @map("plano_expira_em")
  rotasNoMes          Int                  @default(0) @map("rotas_no_mes")
  mesAtual            Int                  @default(1) @map("mes_atual")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  deletedAt           DateTime?            @map("deleted_at")
  descontoAtivo       Float?               @map("desconto_ativo")
  promocaoAtiva       String?              @map("promocao_ativa")
  promocaoExpiraEm    DateTime?            @map("promocao_expira_em")
  trialExpiraEm       DateTime?            @map("trial_expira_em")
  trialUsado          Boolean              @default(false) @map("trial_usado")
  empresasGerenciadas Empresa[]            @relation("GestorEmpresa")
  motoristaVinculado  Motorista?
  notificacoes        Notificacao[]
  pagamentos          Pagamento[]
  passwordResetTokens PasswordResetToken[]
  refreshTokens       RefreshToken[]
  rotas               Rota[]
  tokensPush          TokenPush[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String    @map("user_id")
  email     String
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model LimitesPlano {
  id                 String  @id @default(uuid())
  plano              Plano   @unique
  rotasDia           Int     @default(3) @map("rotas_dia")
  stopsPorRota       Int     @default(10) @map("stops_por_rota")
  rotasMes           Int     @default(90) @map("rotas_mes")
  ocrHabilitado      Boolean @default(false) @map("ocr_habilitado")
  whatsappShare      Boolean @default(false) @map("whatsapp_share")
  analytics          Boolean @default(false)
  sefazIntegration   Boolean @default(false) @map("sefaz_integration")
  podHabilitado      Boolean @default(false) @map("pod_habilitado")
  apiAccess          Boolean @default(false) @map("api_access")
  mlFeatures         Boolean @default(false) @map("ml_features")
  maxMotoristas      Int?    @map("max_motoristas")
  geofencing         Boolean @default(false)
  vtexIntegration    Boolean @default(false) @map("vtex_integration")
  shopifyIntegration Boolean @default(false) @map("shopify_integration")
  precoMensal        Float   @map("preco_mensal")
  precoAnual         Float?  @map("preco_anual")

  @@map("limites_plano")
}

model Promocao {
  id               String       @id @default(uuid())
  codigo           String       @unique
  nome             String
  descricao        String?
  tipoDesconto     TipoDesconto @map("tipo_desconto")
  valorDesconto    Float        @map("valor_desconto")
  planosAplicaveis String[]     @map("planos_aplicaveis")
  mesesGratis      Int?         @map("meses_gratis")
  mesesDesconto    Int?         @map("meses_desconto")
  inicioValidade   DateTime     @map("inicio_validade")
  fimValidade      DateTime     @map("fim_validade")
  usoMaximo        Int?         @map("uso_maximo")
  usosAtuais       Int          @default(0) @map("usos_atuais")
  ativo            Boolean      @default(true)
  createdAt        DateTime     @default(now()) @map("created_at")
  cuponsUsados     CupomUso[]

  @@map("promocoes")
}

model CupomUso {
  id               String   @id @default(uuid())
  promocaoId       String   @map("promocao_id")
  userId           String   @map("user_id")
  planoAplicado    Plano    @map("plano_aplicado")
  descontoAplicado Float    @map("desconto_aplicado")
  dataUso          DateTime @default(now()) @map("data_uso")
  beneficioInicio  DateTime @map("beneficio_inicio")
  beneficioFim     DateTime @map("beneficio_fim")
  promocao         Promocao @relation(fields: [promocaoId], references: [id])

  @@unique([promocaoId, userId])
  @@map("cupom_uso")
}

model Rota {
  id                 String             @id @default(uuid())
  userId             String             @map("user_id")
  origemLat          Float              @map("origem_lat")
  origemLng          Float              @map("origem_lng")
  origemEndereco     String             @map("origem_endereco")
  origemFonte        String             @map("origem_fonte")
  distanciaTotalKm   Float?             @map("distancia_total_km")
  tempoViagemMin     Float?             @map("tempo_viagem_min")
  tempoEntregasMin   Float?             @map("tempo_entregas_min")
  combustivelL       Float?             @map("combustivel_l")
  custoR             Float?             @map("custo_r")
  status             StatusRota         @default(RASCUNHO)
  incluirRetorno     Boolean            @default(true) @map("incluir_retorno")
  calculadaEm        DateTime?          @map("calculada_em")
  iniciadaEm         DateTime?          @map("iniciada_em")
  finalizadaEm       DateTime?          @map("finalizada_em")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  distanciaTotal     Float?             @map("distancia_total")
  entregasFalhas     Int?               @map("entregas_falhas")
  entregasRealizadas Int?               @map("entregas_realizadas")
  ultimaLat          Float?             @map("ultima_lat")
  ultimaLng          Float?             @map("ultima_lng")
  ultimaPosicaoEm    DateTime?          @map("ultima_posicao_em")
  paradas            Parada[]
  posicaoHistorico   PosicaoHistorico[]
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  statusHistorico    StatusHistorico[]
  caixas             CaixaEscaneada[]   // Caixas escaneadas para matching

  // Preparação pelo armazenista (upload/download)
  statusPreparacao   String?   @default("NAO_PREPARADA") @map("status_preparacao") // NAO_PREPARADA, PREPARANDO, PRONTA
  preparadaPorId     String?   @map("preparada_por_id") // ID do armazenista
  preparadaEm        DateTime? @map("preparada_em")
  baixadaPorId       String?   @map("baixada_por_id") // ID do motorista que baixou
  baixadaEm          DateTime? @map("baixada_em")

  @@map("rotas")
}

model Parada {
  id                String            @id @default(uuid())
  rotaId            String            @map("rota_id")
  lat               Float
  lng               Float
  endereco          String
  cidade            String
  uf                String
  cep               String?
  nome              String
  telefone          String?
  fornecedor        String
  fonte             String
  confianca         Float             @default(1.0)
  ordem             Int?
  distanciaAnterior Float?            @map("distancia_anterior")
  tempoAnterior     Float?            @map("tempo_anterior")
  statusEntrega     StatusEntrega     @default(PENDENTE) @map("status_entrega")
  entregueEm        DateTime?         @map("entregue_em")
  observacao        String?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  janelaFim         String?           @map("janela_fim")
  janelaInicio      String?           @map("janela_inicio")
  prioridade        Prioridade        @default(MEDIA)
  motivoFalha       String?           @map("motivo_falha")
  observacaoFalha   String?           @map("observacao_falha")
  status            String?           @default("PENDENTE")
  rota              Rota              @relation(fields: [rotaId], references: [id], onDelete: Cascade)
  pod               ProofOfDelivery?
  statusHistorico   StatusHistorico[]

  // ==========================================
  // MATCHING CAIXA ↔ NF-e
  // ==========================================
  // Tag visual para identificação rápida no veículo
  // Formato: {NOME3}-{CEP3}-{ITENS} = Ex: PAU-474-09
  tagVisual     String? @map("tag_visual")
  tagCor        Int?    @map("tag_cor") // 1-8 para cores diferentes
  
  // Dados de matching
  matchScore    Float?  @map("match_score") // Pontuação do matching (0-100)
  caixaId       String? @map("caixa_id") // ID da caixa pareada
  
  // Dados extraídos da etiqueta da caixa
  pedido        String? // Número do pedido
  remessa       String? // Número da remessa/REM
  subrota       String? // Código da SubRota
  itens         Int?    // Quantidade de itens
  pesoKg        Float?  @map("peso_kg") // Peso em kg
  valorNf       Float?  @map("valor_nf") // Valor da NF-e
  
  // Relacionamento com caixa (opcional)
  caixa         CaixaEscaneada? @relation(fields: [caixaId], references: [id])

  @@map("paradas")
}

model ProofOfDelivery {
  id                     String   @id @default(uuid())
  paradaId               String   @unique @map("parada_id")
  tipo                   TipoPOD
  fotoUrl                String?  @map("foto_url")
  assinaturaUrl          String?  @map("assinatura_url")
  codigo                 String?
  latitude               Float
  longitude              Float
  precisaoGps            Float?   @map("precisao_gps")
  distanciaMetros        Int?     @map("distancia_metros")
  alertaDistancia        Boolean  @default(false) @map("alerta_distancia")
  timestamp              DateTime @default(now())
  observacao             String?
  sincronizadoFornecedor Boolean  @default(false) @map("sincronizado_fornecedor")
  protocoloFornecedor    String?  @map("protocolo_fornecedor")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
  parada                 Parada   @relation(fields: [paradaId], references: [id], onDelete: Cascade)

  @@map("proof_of_delivery")
}

// ==========================================
// CAIXA ESCANEADA - Etiquetas fotografadas
// ==========================================
// @description Armazena dados extraídos das etiquetas das caixas
// @pre Foto deve ser processada por OCR
// @post Dados disponíveis para matching com NF-e

model CaixaEscaneada {
  id     String @id @default(uuid())
  rotaId String @map("rota_id")
  
  // Imagem original
  fotoUrl     String?  @map("foto_url") // URL ou base64
  fotoThumb   String?  @map("foto_thumb") // Thumbnail para preview
  
  // Dados extraídos via OCR
  pedido      String? // PED - pedido
  remessa     String? // REM - remessa
  destinatario String? // Nome do destinatário
  cep         String?
  bairro      String?
  cidade      String?
  uf          String?
  
  // Detalhes do pacote
  itens       Int?    // Quantidade de itens
  pesoKg      Float?  @map("peso_kg")
  barcode     String? // Código de barras
  
  // Status do processamento
  statusOcr   String  @default("PENDENTE") @map("status_ocr") // PENDENTE, PROCESSANDO, SUCESSO, ERRO
  confianca   Float?  // Confiança do OCR (0-1)
  textoRaw    String? @map("texto_raw") // Texto bruto do OCR
  
  // Status do matching
  statusMatch String  @default("PENDENTE") @map("status_match") // PENDENTE, PAREADO, SEM_MATCH
  paradaId    String? @map("parada_id") // ID da parada pareada
  matchScore  Float?  @map("match_score")
  
  // Suporte a múltiplas caixas por NF-e (N:1)
  numeroCaixa Int?    @map("numero_caixa") // Ex: 1 de 2 -> numeroCaixa=1
  totalCaixas Int?    @map("total_caixas") // Ex: 1 de 2 -> totalCaixas=2
  grupoCaixaId String? @map("grupo_caixa_id") // UUID para agrupar caixas do mesmo pedido
  
  // Tag visual (mesma para caixas do mesmo pedido)
  tagVisual   String? @map("tag_visual")
  tagCor      Int?    @map("tag_cor")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relacionamentos
  rota        Rota     @relation(fields: [rotaId], references: [id], onDelete: Cascade)
  paradas     Parada[]
  
  @@map("caixas_escaneadas")
}

model Pagamento {
  id             String          @id @default(uuid())
  mpPreferenceId String?         @map("mp_preference_id")
  mpPaymentId    String?         @map("mp_payment_id")
  userId         String          @map("user_id")
  plano          Plano
  valorCentavos  Int             @map("valor_centavos")
  moeda          String          @default("BRL")
  status         StatusPagamento @default(PENDENTE)
  pagoEm         DateTime?       @map("pago_em")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pagamentos")
}

model ConfiguracaoSistema {
  id        String   @id @default(uuid())
  chave     String   @unique
  valor     String
  descricao String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("configuracoes_sistema")
}

model HistoricoTempo {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  origemLat        Float    @map("origem_lat")
  origemLng        Float    @map("origem_lng")
  destinoLat       Float    @map("destino_lat")
  destinoLng       Float    @map("destino_lng")
  tempoEstimadoMin Float    @map("tempo_estimado_min")
  tempoRealMin     Float    @map("tempo_real_min")
  fatorCorrecao    Float    @map("fator_correcao")
  horaInicio       Int      @map("hora_inicio")
  diaSemana        Int      @map("dia_semana")
  distanciaKm      Float    @map("distancia_km")
  dataViagem       DateTime @map("data_viagem")
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([horaInicio])
  @@index([diaSemana])
  @@map("historico_tempo")
}

model TokenPush {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  endpoint     String
  p256dh       String
  auth         String
  platform     String   @default("web")
  deviceId     String?  @map("device_id")
  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime @updatedAt @map("atualizado_em")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("tokens_push")
}

model Notificacao {
  id       String    @id @default(uuid())
  userId   String    @map("user_id")
  tipo     String
  titulo   String
  mensagem String
  icone    String?
  rotaId   String?   @map("rota_id")
  paradaId String?   @map("parada_id")
  dados    String?
  acaoUrl  String?   @map("acao_url")
  lida     Boolean   @default(false)
  lidaEm   DateTime? @map("lida_em")
  criadaEm DateTime  @default(now()) @map("criada_em")
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, lida])
  @@index([tipo])
  @@map("notificacoes")
}

model StatusHistorico {
  id          String   @id @default(uuid())
  paradaId    String?  @map("parada_id")
  rotaId      String   @map("rota_id")
  status      String
  motivoFalha String?  @map("motivo_falha")
  observacao  String?
  lat         Float?
  lng         Float?
  timestamp   DateTime @default(now())
  parada      Parada?  @relation(fields: [paradaId], references: [id], onDelete: Cascade)
  rota        Rota     @relation(fields: [rotaId], references: [id], onDelete: Cascade)

  @@index([rotaId])
  @@index([paradaId])
  @@index([timestamp])
  @@map("status_historico")
}

model PosicaoHistorico {
  id         String   @id @default(uuid())
  rotaId     String   @map("rota_id")
  lat        Float
  lng        Float
  heading    Float?
  velocidade Float?
  precisao   Float?
  timestamp  DateTime @default(now())
  rota       Rota     @relation(fields: [rotaId], references: [id], onDelete: Cascade)

  @@index([rotaId])
  @@index([timestamp])
  @@map("posicao_historico")
}

model Empresa {
  id                 String                 @id @default(uuid())
  nome               String
  cnpj               String?                @unique
  email              String
  telefone           String?
  gestorId           String                 @map("gestor_id")
  limiteMotoristas   Int                    @default(10) @map("limite_motoristas")
  limiteVeiculos     Int                    @default(10) @map("limite_veiculos")
  baseLat            Float?                 @map("base_lat")
  baseLng            Float?                 @map("base_lng")
  baseEndereco       String?                @map("base_endereco")
  modoDistribuicao   ModoDistribuicao       @default(AUTOMATICO) @map("modo_distribuicao")
  balanceamentoCarga Boolean                @default(true) @map("balanceamento_carga")
  respeitarZonas     Boolean                @default(true) @map("respeitar_zonas")
  ativo              Boolean                @default(true)
  createdAt          DateTime               @default(now()) @map("created_at")
  updatedAt          DateTime               @updatedAt @map("updated_at")
  deletedAt          DateTime?              @map("deleted_at")
  apiKeys            ApiKey[]
  configuracaoSefaz  ConfiguracaoSefaz?
  gestor             User                   @relation("GestorEmpresa", fields: [gestorId], references: [id])
  equipes            Equipe[]
  integracoes        IntegracaoFornecedor[]
  motoristas         Motorista[]
  rotasEmpresa       RotaEmpresa[]
  veiculos           Veiculo[]
  zonasAtuacao       ZonaAtuacao[]

  @@index([gestorId])
  @@map("empresas")
}

model Motorista {
  id                   String                 @id @default(uuid())
  empresaId            String                 @map("empresa_id")
  nome                 String
  email                String
  telefone             String
  cpf                  String?
  cnh                  String?
  cnhValidade          DateTime?              @map("cnh_validade")
  foto                 String?
  userId               String?                @unique @map("user_id")
  pin                  String?
  status               StatusMotorista        @default(DISPONIVEL)
  statusAtualizadoEm   DateTime?              @map("status_atualizado_em")
  motivoIndisponivel   String?                @map("motivo_indisponivel")
  ultimaLat            Float?                 @map("ultima_lat")
  ultimaLng            Float?                 @map("ultima_lng")
  ultimaPosicaoEm      DateTime?              @map("ultima_posicao_em")
  capacidadeKg         Float                  @default(100) @map("capacidade_kg")
  capacidadeVolumes    Int                    @default(50) @map("capacidade_volumes")
  raioMaximoKm         Float                  @default(50) @map("raio_maximo_km")
  taxaEntrega          Float                  @default(100) @map("taxa_entrega")
  tempoMedioEntrega    Float                  @default(5) @map("tempo_medio_entrega")
  avaliacaoMedia       Float                  @default(5) @map("avaliacao_media")
  totalEntregas        Int                    @default(0) @map("total_entregas")
  totalKm              Float                  @default(0) @map("total_km")
  horaInicio           String?                @map("hora_inicio")
  horaFim              String?                @map("hora_fim")
  diasTrabalho         String?                @map("dias_trabalho")
  veiculoAtualId       String?                @map("veiculo_atual_id")
  equipeId             String?                @map("equipe_id")
  ativo                Boolean                @default(true)
  createdAt            DateTime               @default(now()) @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")
  deletedAt            DateTime?              @map("deleted_at")
  historicoAtribuicoes AtribuicaoHistorico[]
  eventosGeofence      EventoGeofence[]
  zonasPreferidas      MotoristaZona[]
  empresa              Empresa                @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  equipe               Equipe?                @relation(fields: [equipeId], references: [id])
  user                 User?                  @relation(fields: [userId], references: [id])
  veiculoAtual         Veiculo?               @relation("MotoristaVeiculoAtual", fields: [veiculoAtualId], references: [id])
  performanceHistorico PerformanceMotorista[]
  rotasAtribuidas      RotaEmpresa[]          @relation("MotoristaRotas")

  @@index([empresaId])
  @@index([status])
  @@index([equipeId])
  @@map("motoristas")
}

model Veiculo {
  id                String             @id @default(uuid())
  empresaId         String             @map("empresa_id")
  placa             String
  modelo            String
  marca             String?
  ano               Int?
  cor               String?
  tipo              TipoVeiculo        @default(MOTO)
  capacidadeKg      Float              @default(50) @map("capacidade_kg")
  capacidadeVolumes Int                @default(20) @map("capacidade_volumes")
  capacidadeM3      Float?             @map("capacidade_m3")
  consumoKmL        Float              @default(15) @map("consumo_km_l")
  tipoCombustivel   String?            @map("tipo_combustivel")
  renavam           String?
  chassi            String?
  seguroVencimento  DateTime?          @map("seguro_vencimento")
  ipvaVencimento    DateTime?          @map("ipva_vencimento")
  status            StatusVeiculo      @default(DISPONIVEL)
  kmAtual           Float              @default(0) @map("km_atual")
  ultimaManutencao  DateTime?          @map("ultima_manutencao")
  proximaManutencao DateTime?          @map("proxima_manutencao")
  ativo             Boolean            @default(true)
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  motoristasUsando  Motorista[]        @relation("MotoristaVeiculoAtual")
  historicoUso      VeiculoHistorico[]
  empresa           Empresa            @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@unique([empresaId, placa])
  @@index([empresaId])
  @@index([status])
  @@map("veiculos")
}

model Equipe {
  id           String       @id @default(uuid())
  empresaId    String       @map("empresa_id")
  nome         String
  descricao    String?
  cor          String?
  liderId      String?      @map("lider_id")
  zonaPadraoId String?      @map("zona_padrao_id")
  ativo        Boolean      @default(true)
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  empresa      Empresa      @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  zonaPadrao   ZonaAtuacao? @relation(fields: [zonaPadraoId], references: [id])
  motoristas   Motorista[]

  @@index([empresaId])
  @@map("equipes")
}

model ZonaAtuacao {
  id                   String                @id @default(uuid())
  empresaId            String                @map("empresa_id")
  nome                 String
  descricao            String?
  cor                  String?
  poligono             String?
  centroLat            Float?                @map("centro_lat")
  centroLng            Float?                @map("centro_lng")
  raioKm               Float?                @map("raio_km")
  cidades              String?
  bairros              String?
  ceps                 String?
  prioridade           Int                   @default(1)
  ativo                Boolean               @default(true)
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  configuracaoGeofence ConfiguracaoGeofence?
  equipesZona          Equipe[]
  eventosGeofence      EventoGeofence[]
  motoristasZona       MotoristaZona[]
  empresa              Empresa               @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@map("zonas_atuacao")
}

model MotoristaZona {
  id          String      @id @default(uuid())
  motoristaId String      @map("motorista_id")
  zonaId      String      @map("zona_id")
  prioridade  Int         @default(1)
  motorista   Motorista   @relation(fields: [motoristaId], references: [id], onDelete: Cascade)
  zona        ZonaAtuacao @relation(fields: [zonaId], references: [id], onDelete: Cascade)

  @@unique([motoristaId, zonaId])
  @@map("motorista_zonas")
}

model RotaEmpresa {
  id               String           @id @default(uuid())
  empresaId        String           @map("empresa_id")
  motoristaId      String?          @map("motorista_id")
  rotaOriginalId   String?          @map("rota_original_id")
  statusAtribuicao StatusAtribuicao @default(PENDENTE) @map("status_atribuicao")
  atribuidoEm      DateTime?        @map("atribuido_em")
  aceitoEm         DateTime?        @map("aceito_em")
  recusadoEm       DateTime?        @map("recusado_em")
  motivoRecusa     String?          @map("motivo_recusa")
  origemLat        Float            @map("origem_lat")
  origemLng        Float            @map("origem_lng")
  origemEndereco   String           @map("origem_endereco")
  totalParadas     Int              @default(0) @map("total_paradas")
  distanciaKm      Float?           @map("distancia_km")
  tempoEstimadoMin Float?           @map("tempo_estimado_min")
  pesoTotalKg      Float?           @map("peso_total_kg")
  volumeTotal      Int?             @map("volume_total")
  status           StatusRota       @default(RASCUNHO)
  iniciadaEm       DateTime?        @map("iniciada_em")
  finalizadaEm     DateTime?        @map("finalizada_em")
  entreguesCount   Int              @default(0) @map("entregues_count")
  falhasCount      Int              @default(0) @map("falhas_count")
  kmReal           Float?           @map("km_real")
  tempoRealMin     Float?           @map("tempo_real_min")
  custoReal        Float?           @map("custo_real")
  notaAvaliacao    Float?           @map("nota_avaliacao")
  dataRota         DateTime         @default(now()) @map("data_rota")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  cargaVeiculoId   String?
  paradasEmpresa   ParadaEmpresa[]
  cargaVeiculo     CargaVeiculo?    @relation(fields: [cargaVeiculoId], references: [id])
  empresa          Empresa          @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  motorista        Motorista?       @relation("MotoristaRotas", fields: [motoristaId], references: [id])

  @@index([empresaId])
  @@index([motoristaId])
  @@index([status])
  @@index([dataRota])
  @@map("rotas_empresa")
}

model ParadaEmpresa {
  id            String      @id @default(uuid())
  rotaEmpresaId String      @map("rota_empresa_id")
  lat           Float
  lng           Float
  endereco      String
  cidade        String
  uf            String
  cep           String?
  bairro        String?
  nome          String
  telefone      String?
  ordem         Int?
  pesoKg        Float?      @map("peso_kg")
  volumes       Int         @default(1)
  valor         Float?
  janelaInicio  String?     @map("janela_inicio")
  janelaFim     String?     @map("janela_fim")
  prioridade    Prioridade  @default(MEDIA)
  status        String      @default("PENDENTE")
  entregueEm    DateTime?   @map("entregue_em")
  motivoFalha   String?     @map("motivo_falha")
  observacao    String?
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  rotaEmpresa   RotaEmpresa @relation(fields: [rotaEmpresaId], references: [id], onDelete: Cascade)

  @@index([rotaEmpresaId])
  @@map("paradas_empresa")
}

model AtribuicaoHistorico {
  id               String    @id @default(uuid())
  motoristaId      String    @map("motorista_id")
  rotaEmpresaId    String?   @map("rota_empresa_id")
  acao             String
  motivo           String?
  atribuidoPor     String?   @map("atribuido_por")
  metodoAtribuicao String?   @map("metodo_atribuicao")
  timestamp        DateTime  @default(now())
  motorista        Motorista @relation(fields: [motoristaId], references: [id], onDelete: Cascade)

  @@index([motoristaId])
  @@index([timestamp])
  @@map("atribuicao_historico")
}

model PerformanceMotorista {
  id                String    @id @default(uuid())
  motoristaId       String    @map("motorista_id")
  data              DateTime  @db.Date
  totalRotas        Int       @default(0) @map("total_rotas")
  totalEntregas     Int       @default(0) @map("total_entregas")
  entregasSucesso   Int       @default(0) @map("entregas_sucesso")
  entregasFalha     Int       @default(0) @map("entregas_falha")
  kmRodados         Float     @default(0) @map("km_rodados")
  tempoTrabalhoMin  Float     @default(0) @map("tempo_trabalho_min")
  tempoEntregasMin  Float     @default(0) @map("tempo_entregas_min")
  taxaSucesso       Float?    @map("taxa_sucesso")
  tempoMedioEntrega Float?    @map("tempo_medio_entrega")
  entregrasPorHora  Float?    @map("entregas_por_hora")
  avaliacaoMedia    Float?    @map("avaliacao_media")
  totalAvaliacoes   Int       @default(0) @map("total_avaliacoes")
  custoCombustivel  Float?    @map("custo_combustivel")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  motorista         Motorista @relation(fields: [motoristaId], references: [id], onDelete: Cascade)

  @@unique([motoristaId, data])
  @@index([motoristaId])
  @@index([data])
  @@map("performance_motorista")
}

model VeiculoHistorico {
  id               String    @id @default(uuid())
  veiculoId        String    @map("veiculo_id")
  motoristaId      String?   @map("motorista_id")
  dataInicio       DateTime  @map("data_inicio")
  dataFim          DateTime? @map("data_fim")
  kmInicio         Float     @map("km_inicio")
  kmFim            Float?    @map("km_fim")
  combustivelL     Float?    @map("combustivel_l")
  custoCombustivel Float?    @map("custo_combustivel")
  veiculo          Veiculo   @relation(fields: [veiculoId], references: [id], onDelete: Cascade)

  @@index([veiculoId])
  @@index([dataInicio])
  @@map("veiculo_historico")
}

model ApiKey {
  id                 String          @id @default(uuid())
  keyHash            String          @unique @map("key_hash")
  keyPrefix          String          @map("key_prefix")
  nome               String
  empresaId          String?         @map("empresa_id")
  userId             String?         @map("user_id")
  permissoes         String[]
  rateLimitPorMinuto Int             @default(100) @map("rate_limit_por_minuto")
  ambiente           AmbienteApi     @default(PRODUCAO)
  ativo              Boolean         @default(true)
  expiresAt          DateTime?       @map("expires_at")
  ultimoUso          DateTime?       @map("ultimo_uso")
  totalRequisicoes   Int             @default(0) @map("total_requisicoes")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  revogadoEm         DateTime?       @map("revogado_em")
  empresa            Empresa?        @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  logsApi            LogApiPublica[]
  webhooks           Webhook[]

  @@index([keyPrefix])
  @@index([empresaId])
  @@index([userId])
  @@map("api_keys")
}

model Webhook {
  id            String           @id @default(uuid())
  apiKeyId      String           @map("api_key_id")
  url           String
  eventos       String[]
  segredo       String
  ativo         Boolean          @default(true)
  totalEnvios   Int              @default(0) @map("total_envios")
  totalSucessos Int              @default(0) @map("total_sucessos")
  totalFalhas   Int              @default(0) @map("total_falhas")
  ultimoEnvio   DateTime?        @map("ultimo_envio")
  ultimoStatus  Int?             @map("ultimo_status")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  entregas      WebhookEntrega[]
  apiKey        ApiKey           @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@map("webhooks")
}

model WebhookEntrega {
  id               String               @id @default(uuid())
  webhookId        String               @map("webhook_id")
  evento           String
  payload          String
  status           StatusWebhookEntrega @default(PENDENTE)
  tentativas       Int                  @default(0)
  proximaTentativa DateTime?            @map("proxima_tentativa")
  httpStatus       Int?                 @map("http_status")
  resposta         String?
  erro             String?
  createdAt        DateTime             @default(now()) @map("created_at")
  enviadoEm        DateTime?            @map("enviado_em")
  webhook          Webhook              @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([proximaTentativa])
  @@map("webhook_entregas")
}

model LogApiPublica {
  id         String   @id @default(uuid())
  apiKeyId   String   @map("api_key_id")
  metodo     String
  path       String
  ip         String?
  userAgent  String?  @map("user_agent")
  statusCode Int      @map("status_code")
  tempoMs    Int      @map("tempo_ms")
  createdAt  DateTime @default(now()) @map("created_at")
  apiKey     ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([createdAt])
  @@map("log_api_publica")
}

model IntegracaoFornecedor {
  id                     String            @id @default(uuid())
  empresaId              String?           @map("empresa_id")
  userId                 String?           @map("user_id")
  fornecedor             TipoIntegracao
  nome                   String?
  credentials            String
  configJson             String?           @map("config_json")
  ativo                  Boolean           @default(true)
  ultimaSincronizacao    DateTime?         @map("ultima_sincronizacao")
  totalPedidosImportados Int               @default(0) @map("total_pedidos_importados")
  createdAt              DateTime          @default(now()) @map("created_at")
  updatedAt              DateTime          @updatedAt @map("updated_at")
  empresa                Empresa?          @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  pedidosImportados      PedidoImportado[]

  @@index([empresaId])
  @@index([userId])
  @@index([fornecedor])
  @@map("integracoes_fornecedor")
}

model PedidoImportado {
  id           String                @id @default(uuid())
  integracaoId String                @map("integracao_id")
  idExterno    String                @map("id_externo")
  numeroNota   String?               @map("numero_nota")
  cliente      String
  endereco     String
  cidade       String
  uf           String
  cep          String?
  telefone     String?
  valorTotal   Float?                @map("valor_total")
  peso         Float?
  volumes      Int?
  status       StatusPedidoImportado @default(PENDENTE)
  paradaId     String?               @map("parada_id")
  createdAt    DateTime              @default(now()) @map("created_at")
  processadoEm DateTime?             @map("processado_em")
  integracao   IntegracaoFornecedor  @relation(fields: [integracaoId], references: [id], onDelete: Cascade)

  @@unique([integracaoId, idExterno])
  @@index([integracaoId])
  @@index([status])
  @@map("pedidos_importados")
}

model EventoGeofence {
  id                  String             @id @default(uuid())
  motoristaId         String             @map("motorista_id")
  zonaId              String             @map("zona_id")
  rotaId              String?            @map("rota_id")
  tipo                TipoEventoGeofence
  lat                 Float
  lng                 Float
  precisao            Float?
  velocidade          Float?
  enderecoApproximado String?            @map("endereco_approx")
  tempoNaZonaMin      Int?               @map("tempo_na_zona_min")
  notificacaoEnviada  Boolean            @default(false) @map("notificacao_enviada")
  processadoEm        DateTime?          @map("processado_em")
  createdAt           DateTime           @default(now()) @map("created_at")
  motorista           Motorista          @relation(fields: [motoristaId], references: [id], onDelete: Cascade)
  zona                ZonaAtuacao        @relation(fields: [zonaId], references: [id], onDelete: Cascade)

  @@index([motoristaId])
  @@index([zonaId])
  @@index([createdAt])
  @@map("eventos_geofence")
}

model ConfiguracaoGeofence {
  id                   String      @id @default(uuid())
  zonaId               String      @unique @map("zona_id")
  alertaEntrada        Boolean     @default(true) @map("alerta_entrada")
  alertaSaida          Boolean     @default(true) @map("alerta_saida")
  alertaTempoExcedido  Boolean     @default(false) @map("alerta_tempo_excedido")
  tempoMaximoMin       Int         @default(60) @map("tempo_maximo_min")
  debounceSegundos     Int         @default(30) @map("debounce_segundos")
  raioToleranciaMetros Int         @default(50) @map("raio_tolerancia_metros")
  notificarGestor      Boolean     @default(true) @map("notificar_gestor")
  notificarMotorista   Boolean     @default(false) @map("notificar_motorista")
  webhookUrl           String?     @map("webhook_url")
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")
  zona                 ZonaAtuacao @relation(fields: [zonaId], references: [id], onDelete: Cascade)

  @@map("configuracoes_geofence")
}

model CacheSefaz {
  id               String    @id @default(uuid())
  chaveAcesso      String    @unique @map("chave_acesso")
  uf               String
  status           StatusNfe
  protocolo        String?
  dataAutorizacao  DateTime? @map("data_autorizacao")
  dataCancelamento DateTime? @map("data_cancelamento")
  xmlNfe           String?   @map("xml_nfe")
  xmlProcNfe       String?   @map("xml_proc_nfe")
  numero           String?
  serie            String?
  dataEmissao      DateTime? @map("data_emissao")
  valorTotal       Float?    @map("valor_total")
  emitenteCnpj     String?   @map("emitente_cnpj")
  emitenteNome     String?   @map("emitente_nome")
  emitenteUf       String?   @map("emitente_uf")
  destCpfCnpj      String?   @map("dest_cpf_cnpj")
  destNome         String?   @map("dest_nome")
  destEndereco     String?   @map("dest_endereco")
  destNumero       String?   @map("dest_numero")
  destComplemento  String?   @map("dest_complemento")
  destBairro       String?   @map("dest_bairro")
  destCidade       String?   @map("dest_cidade")
  destUf           String?   @map("dest_uf")
  destCep          String?   @map("dest_cep")
  destTelefone     String?   @map("dest_telefone")
  volumes          Int?      @default(1)
  pesoLiquido      Float?    @map("peso_liquido")
  pesoBruto        Float?    @map("peso_bruto")
  consultadoEm     DateTime  @default(now()) @map("consultado_em")
  expiraEm         DateTime  @map("expira_em")
  totalConsultas   Int       @default(1) @map("total_consultas")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@index([chaveAcesso])
  @@index([emitenteCnpj])
  @@index([destCpfCnpj])
  @@index([expiraEm])
  @@map("cache_sefaz")
}

model ConfiguracaoSefaz {
  id                  String        @id @default(uuid())
  empresaId           String        @unique @map("empresa_id")
  certificadoBase64   String?       @map("certificado_base64")
  certificadoSenha    String?       @map("certificado_senha")
  certificadoValidade DateTime?     @map("certificado_validade")
  ambiente            AmbienteSefaz @default(PRODUCAO)
  ufPadrao            String?       @map("uf_padrao")
  consultaAutomatica  Boolean       @default(false) @map("consulta_automatica")
  importarAutomatico  Boolean       @default(false) @map("importar_automatico")
  maxConsultasDia     Int           @default(100) @map("max_consultas_dia")
  consultasHoje       Int           @default(0) @map("consultas_hoje")
  ultimoResetDia      DateTime?     @map("ultimo_reset_dia")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  empresa             Empresa       @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@map("configuracoes_sefaz")
}

model CargaVeiculo {
  id                String        @id @default(uuid())
  veiculoId         String        @map("veiculo_id")
  rotaId            String        @map("rota_id")
  pesoAtualKg       Float         @default(0) @map("peso_atual_kg")
  volumesAtuais     Int           @default(0) @map("volumes_atuais")
  volumeM3Atual     Float         @default(0) @map("volume_m3_atual")
  capacidadeKg      Float         @map("capacidade_kg")
  capacidadeVolumes Int           @map("capacidade_volumes")
  capacidadeM3      Float?        @map("capacidade_m3")
  percentualPeso    Float         @default(0) @map("percentual_peso")
  percentualVolumes Float         @default(0) @map("percentual_volumes")
  alertaEnviado80   Boolean       @default(false) @map("alerta_enviado_80")
  alertaEnviado95   Boolean       @default(false) @map("alerta_enviado_95")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  rotaEmpresas      RotaEmpresa[]

  @@unique([veiculoId, rotaId])
  @@index([rotaId])
  @@map("cargas_veiculo")
}

model AgregacaoDemanda {
  id                String   @id @default(uuid())
  zona              String
  diaSemana         Int      @map("dia_semana")
  horaInicio        Int      @map("hora_inicio")
  fornecedor        String?
  totalEntregas     Int      @default(0) @map("total_entregas")
  mediaEntregasDia  Float    @default(0) @map("media_entregas_dia")
  desvioPadrao      Float    @default(0) @map("desvio_padrao")
  tempoMedioEntrega Float    @default(0) @map("tempo_medio_entrega")
  fatorSazonalidade Float    @default(1.0) @map("fator_sazonalidade")
  periodoInicio     DateTime @map("periodo_inicio")
  periodoFim        DateTime @map("periodo_fim")
  totalDias         Int      @map("total_dias")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([zona, diaSemana, horaInicio, fornecedor])
  @@index([zona])
  @@index([diaSemana, horaInicio])
  @@map("agregacoes_demanda")
}

model PrevisaoDemanda {
  id                String    @id @default(uuid())
  zona              String
  data              DateTime
  horaInicio        Int       @map("hora_inicio")
  horaFim           Int       @map("hora_fim")
  fornecedor        String?
  demandaPrevista   Int       @map("demanda_prevista")
  confianca         Float
  limiteInferior    Int       @map("limite_inferior")
  limiteSuperior    Int       @map("limite_superior")
  fatorDiaSemana    Float     @default(1.0) @map("fator_dia_semana")
  fatorHorario      Float     @default(1.0) @map("fator_horario")
  fatorSazonalidade Float     @default(1.0) @map("fator_sazonalidade")
  fatorTendencia    Float     @default(1.0) @map("fator_tendencia")
  demandaReal       Int?      @map("demanda_real")
  erroAbsoluto      Float?    @map("erro_absoluto")
  validadoEm        DateTime? @map("validado_em")
  createdAt         DateTime  @default(now()) @map("created_at")

  @@index([zona, data])
  @@index([data])
  @@map("previsoes_demanda")
}

model InsightDemanda {
  id         String      @id @default(uuid())
  tipo       TipoInsight
  titulo     String
  descricao  String
  zona       String?
  fornecedor String?
  valor      Float
  comparacao String
  acao       String
  prioridade Int         @default(1)
  confianca  Float       @default(0.8)
  validoAte  DateTime    @map("valido_ate")
  createdAt  DateTime    @default(now()) @map("created_at")

  @@index([tipo])
  @@index([validoAte])
  @@map("insights_demanda")
}

model Badge {
  id             String         @id @default(uuid())
  codigo         String         @unique
  nome           String
  descricao      String
  icone          String
  tipo           TipoBadge
  requisito      Int
  pontos         Int            @default(10)
  raridade       Raridade       @default(COMUM)
  ativo          Boolean        @default(true)
  createdAt      DateTime       @default(now()) @map("created_at")
  usuariosBadges UsuarioBadge[]

  @@map("badges")
}

model UsuarioBadge {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  badgeId        String    @map("badge_id")
  progressoAtual Int       @default(0) @map("progresso_atual")
  desbloqueadoEm DateTime? @map("desbloqueado_em")
  notificado     Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  badge          Badge     @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
  @@index([userId])
  @@map("usuarios_badges")
}

model Ranking {
  id            String         @id @default(uuid())
  userId        String         @map("user_id")
  periodo       PeriodoRanking
  dataInicio    DateTime       @map("data_inicio")
  dataFim       DateTime       @map("data_fim")
  totalEntregas Int            @default(0) @map("total_entregas")
  totalKm       Float          @default(0) @map("total_km")
  tempoMedioMin Float          @default(0) @map("tempo_medio_min")
  taxaSucesso   Float          @default(1.0) @map("taxa_sucesso")
  pontos        Int            @default(0)
  posicao       Int?
  posicaoZona   Int?           @map("posicao_zona")
  zona          String?
  streakAtual   Int            @default(0) @map("streak_atual")
  maiorStreak   Int            @default(0) @map("maior_streak")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@unique([userId, periodo, dataInicio])
  @@index([periodo, dataInicio])
  @@index([posicao])
  @@map("rankings")
}

model Conquista {
  id           String        @id @default(uuid())
  userId       String        @map("user_id")
  tipo         TipoConquista
  valor        Int
  descricao    String
  data         DateTime      @default(now())
  pontosGanhos Int           @default(0) @map("pontos_ganhos")
  createdAt    DateTime      @default(now()) @map("created_at")

  @@index([userId])
  @@index([tipo])
  @@map("conquistas")
}

enum Plano {
  FREE
  PRO
  FULL
  ENTERPRISE
  STARTER
  FROTA_START
  FROTA_PRO
  FROTA_ENTERPRISE
}

enum TipoUsuario {
  ENTREGADOR
  GESTOR_FROTA
}

enum TipoDesconto {
  PERCENTUAL
  VALOR_FIXO
  MESES_GRATIS
}

enum TipoPOD {
  FOTO
  ASSINATURA
  CODIGO
}

enum Prioridade {
  ALTA
  MEDIA
  BAIXA
}

enum StatusRota {
  RASCUNHO
  CALCULADA
  EM_ANDAMENTO
  FINALIZADA
  CANCELADA
  PAUSADA
}

enum StatusEntrega {
  PENDENTE
  ENTREGUE
  AUSENTE
  RECUSADA
  REAGENDADA
}

enum StatusPagamento {
  PENDENTE
  PROCESSANDO
  PAGO
  FALHOU
  CANCELADO
  REEMBOLSADO
}

enum ModoDistribuicao {
  AUTOMATICO
  MANUAL
  HIBRIDO
}

enum StatusMotorista {
  DISPONIVEL
  EM_ROTA
  PAUSADO
  INDISPONIVEL
  OFFLINE
}

enum StatusVeiculo {
  DISPONIVEL
  EM_USO
  MANUTENCAO
  RESERVADO
  INATIVO
}

enum TipoVeiculo {
  MOTO
  BICICLETA
  CARRO
  VAN
  FURGAO
  CAMINHAO_LEVE
  CAMINHAO_MEDIO
  CAMINHAO_PESADO
}

enum StatusAtribuicao {
  PENDENTE
  ACEITO
  RECUSADO
  REATRIBUIDO
  CANCELADO
}

enum AmbienteApi {
  SANDBOX
  PRODUCAO
}

enum StatusWebhookEntrega {
  PENDENTE
  ENVIADO
  FALHOU
  CANCELADO
}

enum TipoIntegracao {
  BLING
  TINY
  VTEX
  SHOPIFY
  WOOCOMMERCE
  MERCADOLIVRE
  MAGALU
  AMAZON
  SHOPEE
  IFOOD
  RAPPI
  CUSTOM
}

enum StatusPedidoImportado {
  PENDENTE
  PROCESSADO
  IGNORADO
  ERRO
}

enum TipoEventoGeofence {
  ENTRADA
  SAIDA
  TEMPO_EXCEDIDO
}

enum StatusNfe {
  AUTORIZADA
  CANCELADA
  DENEGADA
  NAO_ENCONTRADA
  ERRO_CONSULTA
}

enum AmbienteSefaz {
  PRODUCAO
  HOMOLOGACAO
}

enum TipoInsight {
  PICO_DEMANDA
  MELHOR_HORARIO
  FORNECEDOR_PICO
  ZONA_EVITAR
  TENDENCIA
  OPORTUNIDADE
}

enum TipoBadge {
  ENTREGAS
  STREAK
  VELOCIDADE
  PRECISAO
  DISTANCIA
  FORNECEDOR
  ZONA
  ESPECIAL
}

enum Raridade {
  COMUM
  INCOMUM
  RARO
  EPICO
  LENDARIO
}

enum PeriodoRanking {
  DIARIO
  SEMANAL
  MENSAL
  ANUAL
  TOTAL
}

enum TipoConquista {
  PRIMEIRA_ENTREGA
  MARCO_ENTREGAS
  STREAK_RECORD
  MELHOR_DIA
  NOVO_BADGE
  TOP_RANKING
}
