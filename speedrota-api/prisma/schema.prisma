// ==========================================
// SPEEDROTA - PRISMA SCHEMA
// ==========================================
// Design por Contrato:
// - Todas as tabelas têm createdAt/updatedAt
// - IDs são UUIDs
// - Soft delete via deletedAt onde aplicável

generator client {
  provider = "prisma-client-js"
}

// Para desenvolvimento local: SQLite
// Para produção: PostgreSQL
// Configure DATABASE_URL no .env
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USUÁRIOS E AUTENTICAÇÃO
// ==========================================

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String  @map("password_hash")
  nome         String
  telefone     String?

  // Plano de assinatura
  plano         Plano     @default(FREE)
  mpCustomerId  String?   @map("mp_customer_id")
  planoExpiraEm DateTime? @map("plano_expira_em")

  // Limites do plano atual
  rotasNoMes Int @default(0) @map("rotas_no_mes")
  mesAtual   Int @default(1) @map("mes_atual") // 1-12

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relacionamentos
  rotas               Rota[]
  refreshTokens       RefreshToken[]
  pagamentos          Pagamento[]
  passwordResetTokens PasswordResetToken[]
  notificacoes        Notificacao[]
  tokensPush          TokenPush[]
  empresasGerenciadas Empresa[]            @relation("GestorEmpresa")
  motoristaVinculado  Motorista?

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String    @map("user_id")
  email     String
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

enum Plano {
  FREE
  PRO
  FULL
  ENTERPRISE
}

// ==========================================
// ROTAS E PARADAS
// ==========================================

model Rota {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // Origem
  origemLat      Float  @map("origem_lat")
  origemLng      Float  @map("origem_lng")
  origemEndereco String @map("origem_endereco")
  origemFonte    String @map("origem_fonte") // 'gps' | 'manual'

  // Métricas calculadas
  distanciaTotalKm Float? @map("distancia_total_km")
  distanciaTotal   Float? @map("distancia_total") // Alias para km
  tempoViagemMin   Float? @map("tempo_viagem_min")
  tempoEntregasMin Float? @map("tempo_entregas_min")
  combustivelL     Float? @map("combustivel_l")
  custoR           Float? @map("custo_r")

  // Tracking em tempo real
  ultimaLat          Float?    @map("ultima_lat")
  ultimaLng          Float?    @map("ultima_lng")
  ultimaPosicaoEm    DateTime? @map("ultima_posicao_em")
  entregasRealizadas Int?      @map("entregas_realizadas")
  entregasFalhas     Int?      @map("entregas_falhas")

  // Status
  status         StatusRota @default(RASCUNHO)
  incluirRetorno Boolean    @default(true) @map("incluir_retorno")

  // Timestamps
  calculadaEm  DateTime? @map("calculada_em")
  iniciadaEm   DateTime? @map("iniciada_em")
  finalizadaEm DateTime? @map("finalizada_em")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relacionamentos
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  paradas          Parada[]
  posicaoHistorico PosicaoHistorico[] // Tracking de posição
  statusHistorico  StatusHistorico[] // Histórico de status

  @@map("rotas")
}

model Parada {
  id     String @id @default(uuid())
  rotaId String @map("rota_id")

  // Localização
  lat      Float
  lng      Float
  endereco String
  cidade   String
  uf       String
  cep      String?

  // Destinatário
  nome     String
  telefone String?

  // Fornecedor
  fornecedor String // 'natura', 'mercadolivre', etc

  // OCR/Fonte
  fonte     String // 'ocr' | 'manual' | 'pdf'
  confianca Float  @default(1.0) // 0-1

  // Janela de tempo e prioridade (NOVO - Quick Win)
  janelaInicio String?    @map("janela_inicio") // "08:00"
  janelaFim    String?    @map("janela_fim") // "12:00"
  prioridade   Prioridade @default(MEDIA)

  // Ordem na rota (após otimização)
  ordem             Int?
  distanciaAnterior Float? @map("distancia_anterior")
  tempoAnterior     Float? @map("tempo_anterior")

  // Status da entrega
  statusEntrega StatusEntrega @default(PENDENTE) @map("status_entrega")
  entregueEm    DateTime?     @map("entregue_em")
  observacao    String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  rota            Rota              @relation(fields: [rotaId], references: [id], onDelete: Cascade)
  pod             ProofOfDelivery? // Comprovante de entrega (opcional)
  statusHistorico StatusHistorico[] // Histórico de mudanças de status

  // Campos para controle de status estendido
  status          String? @default("PENDENTE") // PENDENTE, EM_TRANSITO, CHEGOU, ENTREGUE, FALHA, CANCELADO, PULADO
  motivoFalha     String? @map("motivo_falha") // CLIENTE_AUSENTE, ENDERECO_NAO_ENCONTRADO, RECUSADO, AVARIADO, OUTRO
  observacaoFalha String? @map("observacao_falha")

  @@map("paradas")
}

// ==========================================
// PROOF OF DELIVERY (POD) - Comprovante de Entrega
// ==========================================
// @description Comprovante de entrega com foto, assinatura ou código
// @pre Parada deve existir e não estar já entregue
// @post Após criar POD, Parada.statusEntrega = ENTREGUE
// @invariant 1 Parada = máximo 1 POD ativo

model ProofOfDelivery {
  id       String @id @default(uuid())
  paradaId String @unique @map("parada_id")

  // Tipo de comprovação
  tipo TipoPOD

  // Dados conforme tipo (apenas um preenchido)
  fotoUrl       String? @map("foto_url") // URL S3/Cloudinary ou base64
  assinaturaUrl String? @map("assinatura_url") // SVG/PNG base64 ou URL
  codigo        String? // Código informado pelo cliente

  // Geolocalização da confirmação
  latitude    Float
  longitude   Float
  precisaoGps Float? @map("precisao_gps") // Precisão em metros

  // Distância do local de entrega (calculado)
  distanciaMetros Int?    @map("distancia_metros")
  alertaDistancia Boolean @default(false) @map("alerta_distancia")

  // Metadados
  timestamp  DateTime @default(now())
  observacao String?

  // Integração com fornecedores (futuro)
  sincronizadoFornecedor Boolean @default(false) @map("sincronizado_fornecedor")
  protocoloFornecedor    String? @map("protocolo_fornecedor")

  // Auditoria
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  parada Parada @relation(fields: [paradaId], references: [id], onDelete: Cascade)

  @@map("proof_of_delivery")
}

// Tipo de comprovante de entrega
enum TipoPOD {
  FOTO
  ASSINATURA
  CODIGO
}

// Prioridade de entrega (NOVO)
enum Prioridade {
  ALTA
  MEDIA
  BAIXA
}

enum StatusRota {
  RASCUNHO // Destinos sendo adicionados
  CALCULADA // Rota otimizada
  EM_ANDAMENTO // Entregador está executando
  FINALIZADA // Todas entregas feitas
  CANCELADA
}

enum StatusEntrega {
  PENDENTE
  ENTREGUE
  AUSENTE // Destinatário ausente
  RECUSADA
  REAGENDADA
}

// ==========================================
// PAGAMENTOS (MERCADO PAGO)
// ==========================================

model Pagamento {
  id String @id @default(uuid())

  // Mercado Pago IDs
  mpPreferenceId String? @map("mp_preference_id")
  mpPaymentId    String? @map("mp_payment_id")

  // Dados do pagamento
  userId        String @map("user_id")
  plano         Plano
  valorCentavos Int    @map("valor_centavos") // Em centavos para evitar floating point
  moeda         String @default("BRL")

  // Status
  status StatusPagamento @default(PENDENTE)

  // Timestamps
  pagoEm    DateTime? @map("pago_em")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pagamentos")
}

enum StatusPagamento {
  PENDENTE
  PROCESSANDO
  PAGO
  FALHOU
  CANCELADO
  REEMBOLSADO
}

// ==========================================
// CONFIGURAÇÕES DO SISTEMA
// ==========================================

model ConfiguracaoSistema {
  id        String  @id @default(uuid())
  chave     String  @unique
  valor     String
  descricao String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("configuracoes_sistema")
}

// ==========================================
// HISTÓRICO DE TEMPO (Tráfego Real-time)
// ==========================================
// @description Armazena tempos reais vs estimados para aprendizado
// @pre Rota finalizada com dados de tempo
// @post Usado para melhorar estimativas futuras

model HistoricoTempo {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // Trajeto
  origemLat  Float @map("origem_lat")
  origemLng  Float @map("origem_lng")
  destinoLat Float @map("destino_lat")
  destinoLng Float @map("destino_lng")

  // Tempos
  tempoEstimadoMin Float @map("tempo_estimado_min")
  tempoRealMin     Float @map("tempo_real_min")
  fatorCorrecao    Float @map("fator_correcao") // tempoReal / tempoEstimado

  // Contexto
  horaInicio  Int   @map("hora_inicio") // 0-23
  diaSemana   Int   @map("dia_semana") // 0-6 (dom-sab)
  distanciaKm Float @map("distancia_km")

  // Timestamps
  dataViagem DateTime @map("data_viagem")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([horaInicio])
  @@index([diaSemana])
  @@map("historico_tempo")
}

// ==========================================
// NOTIFICAÇÕES PUSH
// ==========================================
// @description Sistema de notificações push para alertas em tempo real
// @pre Usuário autenticado e token registrado
// @post Notificações enviadas e rastreadas

model TokenPush {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // Subscription data (Web Push)
  endpoint String
  p256dh   String
  auth     String

  // Device info
  platform String  @default("web") // 'web' | 'android' | 'ios'
  deviceId String? @map("device_id")

  // Timestamps
  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime @updatedAt @map("atualizado_em")

  // Relacionamento
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("tokens_push")
}

model Notificacao {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // Conteúdo
  tipo     String // TRAFEGO_INTENSO, CANCELAMENTO, etc.
  titulo   String
  mensagem String
  icone    String?

  // Referências
  rotaId   String? @map("rota_id")
  paradaId String? @map("parada_id")
  dados    String? // JSON com dados extras
  acaoUrl  String? @map("acao_url")

  // Status
  lida   Boolean   @default(false)
  lidaEm DateTime? @map("lida_em")

  // Timestamps
  criadaEm DateTime @default(now()) @map("criada_em")

  // Relacionamento
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, lida])
  @@index([tipo])
  @@map("notificacoes")
}

// ==========================================
// STATUS EM TEMPO REAL - TRACKING
// ==========================================
// @description Histórico de mudanças de status e tracking de posição
// @pre Rota em andamento
// @post Histórico completo para auditoria e analytics

model StatusHistorico {
  id       String  @id @default(uuid())
  paradaId String? @map("parada_id")
  rotaId   String  @map("rota_id")

  // Status
  status      String // PENDENTE, EM_TRANSITO, CHEGOU, ENTREGUE, FALHA, etc.
  motivoFalha String? @map("motivo_falha")
  observacao  String?

  // Localização no momento
  lat Float?
  lng Float?

  // Timestamp
  timestamp DateTime @default(now())

  // Relacionamentos
  parada Parada? @relation(fields: [paradaId], references: [id], onDelete: Cascade)
  rota   Rota    @relation(fields: [rotaId], references: [id], onDelete: Cascade)

  @@index([rotaId])
  @@index([paradaId])
  @@index([timestamp])
  @@map("status_historico")
}

model PosicaoHistorico {
  id     String @id @default(uuid())
  rotaId String @map("rota_id")

  // Posição
  lat        Float
  lng        Float
  heading    Float? // 0-360 graus
  velocidade Float? // km/h
  precisao   Float? // metros

  // Timestamp
  timestamp DateTime @default(now())

  // Relacionamento
  rota Rota @relation(fields: [rotaId], references: [id], onDelete: Cascade)

  @@index([rotaId])
  @@index([timestamp])
  @@map("posicao_historico")
}

// ==========================================
// MULTI-MOTORISTA / GESTÃO DE FROTA
// ==========================================
// @description Sistema completo de gestão de frota com distribuição inteligente
// @pre Usuário com plano FROTA ou ENTERPRISE
// @post Gestão centralizada de motoristas, veículos e entregas
// @invariant Distribuição otimizada por zona, capacidade e performance

model Empresa {
  id String @id @default(uuid())

  // Dados básicos
  nome     String
  cnpj     String? @unique
  email    String
  telefone String?

  // Proprietário/Gestor principal
  gestorId String @map("gestor_id")

  // Configurações
  limiteMotoristas Int @default(10) @map("limite_motoristas")
  limiteVeiculos   Int @default(10) @map("limite_veiculos")

  // Localização base
  baseLat      Float?  @map("base_lat")
  baseLng      Float?  @map("base_lng")
  baseEndereco String? @map("base_endereco")

  // Configurações de distribuição
  modoDistribuicao   ModoDistribuicao @default(AUTOMATICO) @map("modo_distribuicao")
  balanceamentoCarga Boolean          @default(true) @map("balanceamento_carga")
  respeitarZonas     Boolean          @default(true) @map("respeitar_zonas")

  // Timestamps
  ativo     Boolean   @default(true)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relacionamentos
  gestor            User                   @relation("GestorEmpresa", fields: [gestorId], references: [id])
  motoristas        Motorista[]
  veiculos          Veiculo[]
  equipes           Equipe[]
  zonasAtuacao      ZonaAtuacao[]
  rotasEmpresa      RotaEmpresa[]
  apiKeys           ApiKey[]
  integracoes       IntegracaoFornecedor[]
  configuracaoSefaz ConfiguracaoSefaz?

  @@index([gestorId])
  @@map("empresas")
}

model Motorista {
  id        String @id @default(uuid())
  empresaId String @map("empresa_id")

  // Dados pessoais
  nome        String
  email       String
  telefone    String
  cpf         String?
  cnh         String?
  cnhValidade DateTime? @map("cnh_validade")
  foto        String? // URL da foto

  // Credenciais (se tiver acesso ao app)
  userId String? @unique @map("user_id") // Link com User se usar app
  pin    String? // PIN de 4 dígitos para acesso rápido

  // Status operacional
  status             StatusMotorista @default(DISPONIVEL)
  statusAtualizadoEm DateTime?       @map("status_atualizado_em")
  motivoIndisponivel String?         @map("motivo_indisponivel")

  // Localização atual
  ultimaLat       Float?    @map("ultima_lat")
  ultimaLng       Float?    @map("ultima_lng")
  ultimaPosicaoEm DateTime? @map("ultima_posicao_em")

  // Capacidade e preferências
  capacidadeKg      Float @default(100) @map("capacidade_kg")
  capacidadeVolumes Int   @default(50) @map("capacidade_volumes")
  raioMaximoKm      Float @default(50) @map("raio_maximo_km")

  // Performance (atualizado diariamente)
  taxaEntrega       Float @default(100) @map("taxa_entrega") // %
  tempoMedioEntrega Float @default(5) @map("tempo_medio_entrega") // min
  avaliacaoMedia    Float @default(5) @map("avaliacao_media") // 1-5
  totalEntregas     Int   @default(0) @map("total_entregas")
  totalKm           Float @default(0) @map("total_km")

  // Jornada de trabalho
  horaInicio   String? @map("hora_inicio") // "08:00"
  horaFim      String? @map("hora_fim") // "18:00"
  diasTrabalho String? @map("dias_trabalho") // "1,2,3,4,5" (seg-sex)

  // Veículo atual
  veiculoAtualId String? @map("veiculo_atual_id")

  // Equipe
  equipeId String? @map("equipe_id")

  // Timestamps
  ativo     Boolean   @default(true)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relacionamentos
  empresa              Empresa                @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  user                 User?                  @relation(fields: [userId], references: [id])
  veiculoAtual         Veiculo?               @relation("MotoristaVeiculoAtual", fields: [veiculoAtualId], references: [id])
  equipe               Equipe?                @relation(fields: [equipeId], references: [id])
  zonasPreferidas      MotoristaZona[]
  rotasAtribuidas      RotaEmpresa[]          @relation("MotoristaRotas")
  historicoAtribuicoes AtribuicaoHistorico[]
  performanceHistorico PerformanceMotorista[]
  eventosGeofence      EventoGeofence[]

  @@index([empresaId])
  @@index([status])
  @@index([equipeId])
  @@map("motoristas")
}

model Veiculo {
  id        String @id @default(uuid())
  empresaId String @map("empresa_id")

  // Identificação
  placa  String
  modelo String
  marca  String?
  ano    Int?
  cor    String?

  // Tipo e capacidade
  tipo              TipoVeiculo @default(MOTO)
  capacidadeKg      Float       @default(50) @map("capacidade_kg")
  capacidadeVolumes Int         @default(20) @map("capacidade_volumes")
  capacidadeM3      Float?      @map("capacidade_m3") // Volume em m³

  // Consumo
  consumoKmL      Float   @default(15) @map("consumo_km_l") // km por litro
  tipoCombustivel String? @map("tipo_combustivel") // GASOLINA, ETANOL, DIESEL, ELETRICO

  // Documentação
  renavam          String?
  chassi           String?
  seguroVencimento DateTime? @map("seguro_vencimento")
  ipvaVencimento   DateTime? @map("ipva_vencimento")

  // Status
  status            StatusVeiculo @default(DISPONIVEL)
  kmAtual           Float         @default(0) @map("km_atual")
  ultimaManutencao  DateTime?     @map("ultima_manutencao")
  proximaManutencao DateTime?     @map("proxima_manutencao")

  // Timestamps
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  empresa          Empresa            @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  motoristasUsando Motorista[]        @relation("MotoristaVeiculoAtual")
  historicoUso     VeiculoHistorico[]

  @@unique([empresaId, placa])
  @@index([empresaId])
  @@index([status])
  @@map("veiculos")
}

model Equipe {
  id        String @id @default(uuid())
  empresaId String @map("empresa_id")

  // Dados
  nome      String
  descricao String?
  cor       String? // Cor para identificação visual

  // Líder
  liderId String? @map("lider_id")

  // Zona padrão
  zonaPadraoId String? @map("zona_padrao_id")

  // Timestamps
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  empresa    Empresa      @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  motoristas Motorista[]
  zonaPadrao ZonaAtuacao? @relation(fields: [zonaPadraoId], references: [id])

  @@index([empresaId])
  @@map("equipes")
}

model ZonaAtuacao {
  id        String @id @default(uuid())
  empresaId String @map("empresa_id")

  // Identificação
  nome      String
  descricao String?
  cor       String? // Cor no mapa

  // Polígono (GeoJSON simplificado - array de coordenadas)
  // Formato: [[lat1,lng1], [lat2,lng2], ...]
  poligono String? // JSON do polígono

  // Centro e raio (alternativa ao polígono)
  centroLat Float? @map("centro_lat")
  centroLng Float? @map("centro_lng")
  raioKm    Float? @map("raio_km")

  // Cidades/bairros (lista)
  cidades String? // JSON array de cidades
  bairros String? // JSON array de bairros
  ceps    String? // JSON array de prefixos CEP

  // Prioridade
  prioridade Int @default(1) // 1 = maior prioridade

  // Timestamps
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  empresa              Empresa               @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  motoristasZona       MotoristaZona[]
  equipesZona          Equipe[]
  eventosGeofence      EventoGeofence[]
  configuracaoGeofence ConfiguracaoGeofence?

  @@index([empresaId])
  @@map("zonas_atuacao")
}

// Relação N:N entre Motorista e Zona
model MotoristaZona {
  id          String @id @default(uuid())
  motoristaId String @map("motorista_id")
  zonaId      String @map("zona_id")

  // Preferência (1 = principal)
  prioridade Int @default(1)

  // Motorista
  motorista Motorista   @relation(fields: [motoristaId], references: [id], onDelete: Cascade)
  zona      ZonaAtuacao @relation(fields: [zonaId], references: [id], onDelete: Cascade)

  @@unique([motoristaId, zonaId])
  @@map("motorista_zonas")
}

// Rota atribuída a um motorista da empresa
model RotaEmpresa {
  id             String  @id @default(uuid())
  empresaId      String  @map("empresa_id")
  motoristaId    String? @map("motorista_id")
  rotaOriginalId String? @map("rota_original_id") // Link com Rota se importada

  // Status da atribuição
  statusAtribuicao StatusAtribuicao @default(PENDENTE) @map("status_atribuicao")
  atribuidoEm      DateTime?        @map("atribuido_em")
  aceitoEm         DateTime?        @map("aceito_em")
  recusadoEm       DateTime?        @map("recusado_em")
  motivoRecusa     String?          @map("motivo_recusa")

  // Dados da rota
  origemLat      Float  @map("origem_lat")
  origemLng      Float  @map("origem_lng")
  origemEndereco String @map("origem_endereco")

  // Métricas
  totalParadas     Int    @default(0) @map("total_paradas")
  distanciaKm      Float? @map("distancia_km")
  tempoEstimadoMin Float? @map("tempo_estimado_min")
  pesoTotalKg      Float? @map("peso_total_kg")
  volumeTotal      Int?   @map("volume_total")

  // Execução
  status         StatusRota @default(RASCUNHO)
  iniciadaEm     DateTime?  @map("iniciada_em")
  finalizadaEm   DateTime?  @map("finalizada_em")
  entreguesCount Int        @default(0) @map("entregues_count")
  falhasCount    Int        @default(0) @map("falhas_count")

  // Resultado
  kmReal        Float? @map("km_real")
  tempoRealMin  Float? @map("tempo_real_min")
  custoReal     Float? @map("custo_real")
  notaAvaliacao Float? @map("nota_avaliacao")

  // Timestamps
  dataRota  DateTime @default(now()) @map("data_rota")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  empresa        Empresa         @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  motorista      Motorista?      @relation("MotoristaRotas", fields: [motoristaId], references: [id])
  paradasEmpresa ParadaEmpresa[]
  cargaVeiculo   CargaVeiculo?   @relation(fields: [cargaVeiculoId], references: [id])
  cargaVeiculoId String?

  @@index([empresaId])
  @@index([motoristaId])
  @@index([status])
  @@index([dataRota])
  @@map("rotas_empresa")
}

// Paradas da rota da empresa
model ParadaEmpresa {
  id            String @id @default(uuid())
  rotaEmpresaId String @map("rota_empresa_id")

  // Localização
  lat      Float
  lng      Float
  endereco String
  cidade   String
  uf       String
  cep      String?
  bairro   String?

  // Destinatário
  nome     String
  telefone String?

  // Entrega
  ordem   Int?
  pesoKg  Float? @map("peso_kg")
  volumes Int    @default(1)
  valor   Float? // Valor da entrega/mercadoria

  // Janela de tempo
  janelaInicio String?    @map("janela_inicio")
  janelaFim    String?    @map("janela_fim")
  prioridade   Prioridade @default(MEDIA)

  // Status
  status      String    @default("PENDENTE")
  entregueEm  DateTime? @map("entregue_em")
  motivoFalha String?   @map("motivo_falha")
  observacao  String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamento
  rotaEmpresa RotaEmpresa @relation(fields: [rotaEmpresaId], references: [id], onDelete: Cascade)

  @@index([rotaEmpresaId])
  @@map("paradas_empresa")
}

// Histórico de atribuições
model AtribuicaoHistorico {
  id            String  @id @default(uuid())
  motoristaId   String  @map("motorista_id")
  rotaEmpresaId String? @map("rota_empresa_id")

  // Ação
  acao String // ATRIBUIDO, ACEITO, RECUSADO, REATRIBUIDO, CONCLUIDO

  // Contexto
  motivo           String?
  atribuidoPor     String? @map("atribuido_por") // ID do gestor
  metodoAtribuicao String? @map("metodo_atribuicao") // AUTOMATICO, MANUAL

  // Timestamp
  timestamp DateTime @default(now())

  // Relacionamento
  motorista Motorista @relation(fields: [motoristaId], references: [id], onDelete: Cascade)

  @@index([motoristaId])
  @@index([timestamp])
  @@map("atribuicao_historico")
}

// Performance diária do motorista
model PerformanceMotorista {
  id          String @id @default(uuid())
  motoristaId String @map("motorista_id")

  // Data
  data DateTime @db.Date

  // Métricas do dia
  totalRotas      Int @default(0) @map("total_rotas")
  totalEntregas   Int @default(0) @map("total_entregas")
  entregasSucesso Int @default(0) @map("entregas_sucesso")
  entregasFalha   Int @default(0) @map("entregas_falha")

  // Distância e tempo
  kmRodados        Float @default(0) @map("km_rodados")
  tempoTrabalhoMin Float @default(0) @map("tempo_trabalho_min")
  tempoEntregasMin Float @default(0) @map("tempo_entregas_min")

  // Eficiência
  taxaSucesso       Float? @map("taxa_sucesso") // %
  tempoMedioEntrega Float? @map("tempo_medio_entrega") // min
  entregrasPorHora  Float? @map("entregas_por_hora")

  // Avaliação
  avaliacaoMedia  Float? @map("avaliacao_media")
  totalAvaliacoes Int    @default(0) @map("total_avaliacoes")

  // Custo
  custoCombustivel Float? @map("custo_combustivel")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamento
  motorista Motorista @relation(fields: [motoristaId], references: [id], onDelete: Cascade)

  @@unique([motoristaId, data])
  @@index([motoristaId])
  @@index([data])
  @@map("performance_motorista")
}

// Histórico de uso de veículos
model VeiculoHistorico {
  id          String  @id @default(uuid())
  veiculoId   String  @map("veiculo_id")
  motoristaId String? @map("motorista_id")

  // Período
  dataInicio DateTime  @map("data_inicio")
  dataFim    DateTime? @map("data_fim")

  // Km
  kmInicio Float  @map("km_inicio")
  kmFim    Float? @map("km_fim")

  // Custo
  combustivelL     Float? @map("combustivel_l")
  custoCombustivel Float? @map("custo_combustivel")

  // Relacionamento
  veiculo Veiculo @relation(fields: [veiculoId], references: [id], onDelete: Cascade)

  @@index([veiculoId])
  @@index([dataInicio])
  @@map("veiculo_historico")
}

// ==========================================
// ENUMS MULTI-MOTORISTA
// ==========================================

enum ModoDistribuicao {
  AUTOMATICO // Sistema distribui automaticamente
  MANUAL // Gestor atribui manualmente
  HIBRIDO // Sugestão automática, confirmação manual
}

enum StatusMotorista {
  DISPONIVEL // Pronto para receber entregas
  EM_ROTA // Executando rota
  PAUSADO // Em pausa (almoço, etc)
  INDISPONIVEL // Não disponível (folga, etc)
  OFFLINE // Sem conexão/app fechado
}

enum StatusVeiculo {
  DISPONIVEL // Pronto para uso
  EM_USO // Em uso por motorista
  MANUTENCAO // Em manutenção
  RESERVADO // Reservado para uso futuro
  INATIVO // Fora de operação
}

enum TipoVeiculo {
  MOTO
  BICICLETA
  CARRO
  VAN
  FURGAO
  CAMINHAO_LEVE
  CAMINHAO_MEDIO
  CAMINHAO_PESADO
}

enum StatusAtribuicao {
  PENDENTE // Aguardando aceite
  ACEITO // Motorista aceitou
  RECUSADO // Motorista recusou
  REATRIBUIDO // Reatribuído a outro motorista
  CANCELADO // Cancelado pelo gestor
}

// ==========================================
// API PÚBLICA E INTEGRAÇÕES
// ==========================================
// @description Chaves de API para integrações externas (Bling, Tiny, VTEX, etc.)
// @pre Empresa ou User deve existir
// @post API Key gerada com permissões específicas

model ApiKey {
  id String @id @default(uuid())

  // Chave (hash do token)
  keyHash   String @unique @map("key_hash")
  keyPrefix String @map("key_prefix") // Primeiros 8 chars para identificação
  nome      String // Nome descritivo

  // Proprietário (empresa OU usuário)
  empresaId String? @map("empresa_id")
  userId    String? @map("user_id")

  // Permissões
  permissoes String[] // ['rotas:read', 'rotas:write', 'paradas:write', 'webhooks:write']

  // Rate limiting
  rateLimitPorMinuto Int @default(100) @map("rate_limit_por_minuto")

  // Ambiente
  ambiente AmbienteApi @default(PRODUCAO)

  // Status
  ativo            Boolean   @default(true)
  expiresAt        DateTime? @map("expires_at")
  ultimoUso        DateTime? @map("ultimo_uso")
  totalRequisicoes Int       @default(0) @map("total_requisicoes")

  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  revogadoEm DateTime? @map("revogado_em")

  // Relacionamentos
  empresa  Empresa?        @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  webhooks Webhook[]
  logsApi  LogApiPublica[]

  @@index([keyPrefix])
  @@index([empresaId])
  @@index([userId])
  @@map("api_keys")
}

// Webhooks configurados por integração
model Webhook {
  id       String @id @default(uuid())
  apiKeyId String @map("api_key_id")

  // Configuração
  url     String // URL de callback
  eventos String[] // ['rota.criada', 'parada.entregue', 'rota.finalizada']
  segredo String // Secret para validar assinatura HMAC

  // Status
  ativo Boolean @default(true)

  // Métricas
  totalEnvios   Int       @default(0) @map("total_envios")
  totalSucessos Int       @default(0) @map("total_sucessos")
  totalFalhas   Int       @default(0) @map("total_falhas")
  ultimoEnvio   DateTime? @map("ultimo_envio")
  ultimoStatus  Int?      @map("ultimo_status") // HTTP status code

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  apiKey   ApiKey           @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  entregas WebhookEntrega[]

  @@index([apiKeyId])
  @@map("webhooks")
}

// Log de entregas de webhook (para retry)
model WebhookEntrega {
  id        String @id @default(uuid())
  webhookId String @map("webhook_id")

  // Payload
  evento  String // 'rota.criada', etc.
  payload String @db.Text // JSON do payload

  // Status
  status           StatusWebhookEntrega @default(PENDENTE)
  tentativas       Int                  @default(0)
  proximaTentativa DateTime?            @map("proxima_tentativa")

  // Resposta
  httpStatus Int?    @map("http_status")
  resposta   String? @db.Text
  erro       String?

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  enviadoEm DateTime? @map("enviado_em")

  // Relacionamentos
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([proximaTentativa])
  @@map("webhook_entregas")
}

// Log de requisições da API pública
model LogApiPublica {
  id       String @id @default(uuid())
  apiKeyId String @map("api_key_id")

  // Request
  metodo    String // GET, POST, etc.
  path      String
  ip        String?
  userAgent String? @map("user_agent")

  // Response
  statusCode Int @map("status_code")
  tempoMs    Int @map("tempo_ms")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relacionamentos
  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([createdAt])
  @@map("log_api_publica")
}

// Integrações com ERPs/Fornecedores
model IntegracaoFornecedor {
  id        String  @id @default(uuid())
  empresaId String? @map("empresa_id")
  userId    String? @map("user_id")

  // Fornecedor
  fornecedor TipoIntegracao
  nome       String? // Nome customizado

  // Credenciais (criptografadas)
  credentials String @db.Text // JSON criptografado

  // Configuração
  configJson String? @map("config_json") @db.Text // Mapeamentos, filtros, etc.

  // Status
  ativo                  Boolean   @default(true)
  ultimaSincronizacao    DateTime? @map("ultima_sincronizacao")
  totalPedidosImportados Int       @default(0) @map("total_pedidos_importados")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  empresa           Empresa?          @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  pedidosImportados PedidoImportado[]

  @@index([empresaId])
  @@index([userId])
  @@index([fornecedor])
  @@map("integracoes_fornecedor")
}

// Pedidos importados de ERPs
model PedidoImportado {
  id           String @id @default(uuid())
  integracaoId String @map("integracao_id")

  // Referência externa
  idExterno  String  @map("id_externo") // ID no ERP
  numeroNota String? @map("numero_nota")

  // Dados do pedido
  cliente  String
  endereco String
  cidade   String
  uf       String
  cep      String?
  telefone String?

  // Valores
  valorTotal Float? @map("valor_total")
  peso       Float?
  volumes    Int?

  // Status
  status   StatusPedidoImportado @default(PENDENTE)
  paradaId String?               @map("parada_id") // Se já virou parada

  // Timestamps
  createdAt    DateTime  @default(now()) @map("created_at")
  processadoEm DateTime? @map("processado_em")

  // Relacionamentos
  integracao IntegracaoFornecedor @relation(fields: [integracaoId], references: [id], onDelete: Cascade)

  @@unique([integracaoId, idExterno])
  @@index([integracaoId])
  @@index([status])
  @@map("pedidos_importados")
}

// ==========================================
// ENUMS API PÚBLICA
// ==========================================

enum AmbienteApi {
  SANDBOX
  PRODUCAO
}

enum StatusWebhookEntrega {
  PENDENTE
  ENVIADO
  FALHOU
  CANCELADO
}

enum TipoIntegracao {
  BLING
  TINY
  VTEX
  SHOPIFY
  WOOCOMMERCE
  MERCADOLIVRE
  MAGALU
  AMAZON
  SHOPEE
  IFOOD
  RAPPI
  CUSTOM // Webhook genérico
}

enum StatusPedidoImportado {
  PENDENTE // Aguardando processamento
  PROCESSADO // Virou parada
  IGNORADO // Descartado (duplicado, etc.)
  ERRO // Erro no processamento
}

// ==========================================
// GEOFENCING
// ==========================================
// @description Eventos de entrada/saída de zonas geográficas
// @pre Zona deve ter polígono OU centro+raio definidos
// @post Evento registrado com timestamp e coordenadas
// @invariant Debounce de 30s entre eventos do mesmo tipo

model EventoGeofence {
  id String @id @default(uuid())

  // Relacionamentos
  motoristaId String  @map("motorista_id")
  zonaId      String  @map("zona_id")
  rotaId      String? @map("rota_id") // Rota ativa no momento

  // Evento
  tipo       TipoEventoGeofence
  lat        Float
  lng        Float
  precisao   Float? // Precisão GPS em metros
  velocidade Float? // Velocidade km/h

  // Contexto
  enderecoApproximado String? @map("endereco_approx")
  tempoNaZonaMin      Int?    @map("tempo_na_zona_min") // Só para SAIDA

  // Processamento
  notificacaoEnviada Boolean   @default(false) @map("notificacao_enviada")
  processadoEm       DateTime? @map("processado_em")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relacionamentos
  motorista Motorista   @relation(fields: [motoristaId], references: [id], onDelete: Cascade)
  zona      ZonaAtuacao @relation(fields: [zonaId], references: [id], onDelete: Cascade)

  @@index([motoristaId])
  @@index([zonaId])
  @@index([createdAt])
  @@map("eventos_geofence")
}

// Configuração de alerta por zona
model ConfiguracaoGeofence {
  id String @id @default(uuid())

  zonaId String @map("zona_id")

  // Alertas habilitados
  alertaEntrada       Boolean @default(true) @map("alerta_entrada")
  alertaSaida         Boolean @default(true) @map("alerta_saida")
  alertaTempoExcedido Boolean @default(false) @map("alerta_tempo_excedido")

  // Configurações
  tempoMaximoMin       Int @default(60) @map("tempo_maximo_min") // Alerta se > X min
  debounceSegundos     Int @default(30) @map("debounce_segundos")
  raioToleranciaMetros Int @default(50) @map("raio_tolerancia_metros")

  // Notificações
  notificarGestor    Boolean @default(true) @map("notificar_gestor")
  notificarMotorista Boolean @default(false) @map("notificar_motorista")
  webhookUrl         String? @map("webhook_url")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  zona ZonaAtuacao @relation(fields: [zonaId], references: [id], onDelete: Cascade)

  @@unique([zonaId])
  @@map("configuracoes_geofence")
}

enum TipoEventoGeofence {
  ENTRADA
  SAIDA
  TEMPO_EXCEDIDO
}

// ==========================================
// INTEGRAÇÃO SEFAZ
// ==========================================
// @description Cache de consultas NF-e à SEFAZ
// @pre Chave de 44 dígitos válida
// @post XML armazenado por 7 dias
// @invariant Não consultar mesma chave mais de 1x por hora

model CacheSefaz {
  id String @id @default(uuid())

  // Chave de acesso
  chaveAcesso String @unique @map("chave_acesso") // 44 dígitos
  uf          String // UF do emitente (2 dígitos)

  // Status da NF-e
  status           StatusNfe
  protocolo        String?
  dataAutorizacao  DateTime? @map("data_autorizacao")
  dataCancelamento DateTime? @map("data_cancelamento")

  // XML (comprimido ou referência)
  xmlNfe     String? @map("xml_nfe") // XML da NF-e (pode ser grande)
  xmlProcNfe String? @map("xml_proc_nfe") // XML de processamento

  // Dados extraídos do XML (para consulta rápida)
  numero      String?
  serie       String?
  dataEmissao DateTime? @map("data_emissao")
  valorTotal  Float?    @map("valor_total")

  // Emitente
  emitenteCnpj String? @map("emitente_cnpj")
  emitenteNome String? @map("emitente_nome")
  emitenteUf   String? @map("emitente_uf")

  // Destinatário
  destCpfCnpj     String? @map("dest_cpf_cnpj")
  destNome        String? @map("dest_nome")
  destEndereco    String? @map("dest_endereco")
  destNumero      String? @map("dest_numero")
  destComplemento String? @map("dest_complemento")
  destBairro      String? @map("dest_bairro")
  destCidade      String? @map("dest_cidade")
  destUf          String? @map("dest_uf")
  destCep         String? @map("dest_cep")
  destTelefone    String? @map("dest_telefone")

  // Transporte
  volumes     Int?   @default(1)
  pesoLiquido Float? @map("peso_liquido")
  pesoBruto   Float? @map("peso_bruto")

  // Metadados
  consultadoEm   DateTime @default(now()) @map("consultado_em")
  expiraEm       DateTime @map("expira_em") // Expirar cache após 7 dias
  totalConsultas Int      @default(1) @map("total_consultas")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([chaveAcesso])
  @@index([emitenteCnpj])
  @@index([destCpfCnpj])
  @@index([expiraEm])
  @@map("cache_sefaz")
}

// Configuração de integração SEFAZ por empresa
model ConfiguracaoSefaz {
  id String @id @default(uuid())

  empresaId String @unique @map("empresa_id")

  // Certificado Digital (criptografado)
  certificadoBase64   String?   @map("certificado_base64")
  certificadoSenha    String?   @map("certificado_senha") // Criptografado
  certificadoValidade DateTime? @map("certificado_validade")

  // Ambiente
  ambiente AmbienteSefaz @default(PRODUCAO)
  ufPadrao String?       @map("uf_padrao") // UF padrão para consultas

  // Configurações
  consultaAutomatica Boolean @default(false) @map("consulta_automatica")
  importarAutomatico Boolean @default(false) @map("importar_automatico")

  // Limites
  maxConsultasDia Int       @default(100) @map("max_consultas_dia")
  consultasHoje   Int       @default(0) @map("consultas_hoje")
  ultimoResetDia  DateTime? @map("ultimo_reset_dia")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@map("configuracoes_sefaz")
}

enum StatusNfe {
  AUTORIZADA
  CANCELADA
  DENEGADA
  NAO_ENCONTRADA
  ERRO_CONSULTA
}

enum AmbienteSefaz {
  PRODUCAO
  HOMOLOGACAO
}

// ==========================================
// CAPACIDADE DE VEÍCULO - TRACKING
// ==========================================
// @description Registro de carga do veículo durante a rota
// @pre Veículo atribuído à rota
// @post Atualizado a cada entrega
// @invariant cargaAtualKg <= capacidadeKg (sempre)

model CargaVeiculo {
  id String @id @default(uuid())

  veiculoId String @map("veiculo_id")
  rotaId    String @map("rota_id")

  // Carga atual
  pesoAtualKg   Float @default(0) @map("peso_atual_kg")
  volumesAtuais Int   @default(0) @map("volumes_atuais")
  volumeM3Atual Float @default(0) @map("volume_m3_atual")

  // Capacidade do veículo (snapshot no momento)
  capacidadeKg      Float  @map("capacidade_kg")
  capacidadeVolumes Int    @map("capacidade_volumes")
  capacidadeM3      Float? @map("capacidade_m3")

  // Percentuais
  percentualPeso    Float @default(0) @map("percentual_peso")
  percentualVolumes Float @default(0) @map("percentual_volumes")

  // Alertas
  alertaEnviado80 Boolean @default(false) @map("alerta_enviado_80")
  alertaEnviado95 Boolean @default(false) @map("alerta_enviado_95")

  // Timestamps
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  rotaEmpresas RotaEmpresa[]

  @@unique([veiculoId, rotaId])
  @@index([rotaId])
  @@map("cargas_veiculo")
}
